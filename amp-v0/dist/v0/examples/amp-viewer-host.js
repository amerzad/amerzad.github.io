(function(){function g(a){if("string"!=typeof a)return a;if("{"!=a.charAt(0))return null;try{return JSON.parse(a)}catch(c){return null}}function k(a,c,b){this.j=a;this.o=c;this.C=b}k.prototype.addEventListener=function(a,c){var b=this;this.j.addEventListener("message",function(a){a.origin==b.o&&a.source==b.C&&c(a)})};k.prototype.postMessage=function(a){this.C.postMessage(a,"null"===this.o?"*":this.o)};k.prototype.start=function(){};
function m(a){this.j=null;this.w=a;this.l=!1;this.h=null;this.D=!0;this.I=0;this.A={};this.m={};this.B=null;this.w.addEventListener("message",this.G.bind(this));this.w.start()}
function n(a){return new Promise(function(c){var b=setInterval(function(){function d(a){if((a=g(a.data))&&"__AMPHTML__"===a.app&&"channelOpen"===a.name){clearInterval(b);e.removeEventListener("message",d);var f=new m(e);p(f,a.requestid,"channelOpen",null);c(f)}}var f=new MessageChannel;a.postMessage({app:"__AMPHTML__",name:"handshake-poll"},"*",[f.port2]);var e=f.port1;e.addEventListener("message",d);e.start()},1E3)})}
function q(a,c,b){return new Promise(function(d){function f(e){var h=g(e.data);!h||e.origin!=b||e.source&&e.source!=c||"__AMPHTML__"!==h.app||"channelOpen"!==h.name||(a.removeEventListener("message",f),e=new k(a,b,c),e=new m(e),p(e,h.requestid,"channelOpen",null),d(e))}a.addEventListener("message",f)})}m.prototype.registerHandler=function(a,c){this.m[a]=c};m.prototype.unregisterHandler=function(a){delete this.m[a]};m.prototype.setDefaultHandler=function(a){this.B=a};
m.prototype.G=function(a){if((a=g(a.data))&&"__AMPHTML__"===a.app)if(this.h&&this.D&&a.messagingToken!==this.h)r(this,"amp-viewer-messaging: handleMessage_ error: ","invalid token");else if("q"===a.type)t(this,a);else if("s"===a.type){var c=a.requestid,b=this.A[c];b&&(delete this.A[c],a.error?(r(this,"amp-viewer-messaging: handleResponse_ error: ",a.error),b.reject(Error("Request "+a.name+" failed: "+a.error))):b.resolve(a.data))}};
m.prototype.sendRequest=function(a,c,b){var d=this,f=++this.I,e=void 0;b&&(e=new Promise(function(a,b){d.A[f]={resolve:a,reject:b}}));u(this,{app:"__AMPHTML__",requestid:f,type:"q",name:a,data:c,rsvp:b});return e};function p(a,c,b,d){u(a,{app:"__AMPHTML__",requestid:c,type:"s",name:b,data:d})}
function v(a,c,b,d){var f=d?d.message?d.message:String(d):"unknown error";r(a,"amp-viewer-messaging: sendResponseError_, message name: "+b,f);u(a,{app:"__AMPHTML__",requestid:c,type:"s",name:b,data:null,error:f})}function u(a,c){var b=Object.assign(c,{});a.h&&!a.D&&(b.messagingToken=a.h);a.w.postMessage(a.l?JSON.stringify(b):b)}
function t(a,c){var b=a.m[c.name];b||(b=a.B);if(!b)throw b=Error("Cannot handle request because no default handler is set!"),b.args=c.name,b;b=b(c.name,c.data,!!c.rsvp);if(c.rsvp){var d=c.requestid;if(!b)throw v(a,d,c.name,Error("no response")),Error("expected response but none given: "+c.name);b.then(function(b){p(a,d,c.name,b)},function(b){v(a,d,c.name,b)})}}
function r(a,c,b){if(a.j){var d="amp-messaging-error-logger: "+c;d+=" data: "+(b?b.message?b.message:String(b):"unknown error");a.j.viewerState=d}};function w(a,c,b,d,f,e,h){var l=this;this.win=a;this.F=c;this.H=d;this.l=!!e;this.logsId=f;a=this.F.contentWindow;this.l||h?n(a).then(function(a){l.c=a;x(l)}):q(this.win,a,b).then(function(a){l.c=a;x(l)})}function x(a){a.c.setDefaultHandler(a.H);a.sendRequest("visibilitychange",{state:a.J,prerenderSize:a.prerenderSize},!0)}w.prototype.sendRequest=function(a,c,b){this.log("sendRequest");if(this.c)return this.c.sendRequest(a,c,b)};
w.prototype.log=function(){var a=Array.prototype.slice.call(arguments,0);a.unshift("[ViewerHost "+this.logsId+"]");console.log.apply(console,a)};self.AmpViewerHost=w;})();

//# sourceMappingURL=amp-viewer-host.js.map
