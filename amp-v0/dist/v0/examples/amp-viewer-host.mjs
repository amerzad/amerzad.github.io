(function(){function h(a){if("string"!=typeof a)return a;if("{"!=a.charAt(0))return null;try{return JSON.parse(a)}catch(c){return null}}class k{constructor(a,c,b){this.j=a;this.o=c;this.C=b}addEventListener(a,c){this.j.addEventListener("message",a=>{a.origin==this.o&&a.source==this.C&&c(a)})}postMessage(a){this.C.postMessage(a,"null"===this.o?"*":this.o)}start(){}}function l(a){return new Promise(c=>{let b=setInterval(()=>{let d=new MessageChannel;a.postMessage({app:"__AMPHTML__",name:"handshake-poll"},"*",[d.port2]);let e=d.port1,f=a=>{if((a=h(a.data))&&"__AMPHTML__"===a.app&&"channelOpen"===a.name){clearInterval(b);e.removeEventListener("message",f);let d=new m(null,e,!1,void 0,!0);n(d,a.requestid,"channelOpen",null);c(d)}};e.addEventListener("message",f);e.start()},1e3)})}function p(a,c,b){return new Promise(d=>{let e=f=>{let g=h(f.data);!g||f.origin!=b||f.source&&f.source!=c||"__AMPHTML__"!==g.app||"channelOpen"!==g.name||(a.removeEventListener("message",e),f=new k(a,b,c),f=new m(null,f,!1,void 0,!0),n(f,g.requestid,"channelOpen",null),d(f))};a.addEventListener("message",e)})}function n(a,c,b,d){q(a,{app:"__AMPHTML__",requestid:c,type:"s",name:b,data:d})}function r(a,c,b){if(a.j){var d="amp-messaging-error-logger: "+c;d+=" data: "+(b?b.message?b.message:String(b):"unknown error");a.j.viewerState=d}}function t(a,c){var b=a.m[c.name];b||(b=a.B);if(!b)throw b=Error("Cannot handle request because no default handler is set!"),b.args=c.name,b;b=b(c.name,c.data,!!c.rsvp);if(c.rsvp){let d=c.requestid;if(!b)throw u(a,d,c.name,Error("no response")),Error("expected response but none given: "+c.name);b.then(b=>{n(a,d,c.name,b)},b=>{u(a,d,c.name,b)})}}function q(a,c){let b=Object.assign(c,{});a.h&&!a.D&&(b.messagingToken=a.h);a.w.postMessage(a.l?JSON.stringify(b):b)}function u(a,c,b,d){let e=d?d.message?d.message:String(d):"unknown error";r(a,"amp-viewer-messaging: sendResponseError_, message name: "+b,e);q(a,{app:"__AMPHTML__",requestid:c,type:"s",name:b,data:null,error:e})}class m{constructor(a,c,b,d,e){this.j=a;this.w=c;this.l=!!b;this.h=d||null;this.D=!!e;this.I=0;this.A={};this.m={};this.B=null;this.w.addEventListener("message",this.G.bind(this));this.w.start()}registerHandler(a,c){this.m[a]=c}unregisterHandler(a){delete this.m[a]}setDefaultHandler(a){this.B=a}G(a){if((a=h(a.data))&&"__AMPHTML__"===a.app)if(this.h&&this.D&&a.messagingToken!==this.h)r(this,"amp-viewer-messaging: handleMessage_ error: ","invalid token");else if("q"===a.type)t(this,a);else if("s"===a.type){let c=a.requestid,b=this.A[c];b&&(delete this.A[c],a.error?(r(this,"amp-viewer-messaging: handleResponse_ error: ",a.error),b.reject(Error(`Request ${a.name} failed: ${a.error}`))):b.resolve(a.data))}}sendRequest(a,c,b){let d=++this.I;let e=void 0;b&&(e=new Promise((a,b)=>{this.A[d]={resolve:a,reject:b}}));q(this,{app:"__AMPHTML__",requestid:d,type:"q",name:a,data:c,rsvp:b});return e}}function v(a){a.c.setDefaultHandler(a.H);a.sendRequest("visibilitychange",{state:a.J,prerenderSize:a.prerenderSize},!0)}class w{constructor(a,c,b,d,e,f,g){this.win=a;this.F=c;this.H=d;this.l=!!f;this.logsId=e;a=this.F.contentWindow;this.l||g?l(a).then(a=>{this.c=a;v(this)}):p(this.win,a,b).then(a=>{this.c=a;v(this)})}sendRequest(a,c,b){this.log("sendRequest");if(this.c)return this.c.sendRequest(a,c,b)}log(){let a=Array.prototype.slice.call(arguments,0);a.unshift("[ViewerHost "+this.logsId+"]");console.log.apply(console,a)}}self.AmpViewerHost=w})();